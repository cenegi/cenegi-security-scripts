#!/bin/bash

# Basic Pentest Recon Script
# For authorized security assessments only

TARGET="$1"
MODE="$2"        # captures flags like --proxy
DATE=$(date +"%Y-%m-%d_%H-%M")
SCRIPT_NAME=$(basename "$0")

# ============================
# COLOR PALETTE (Blue-themed)
# ============================
BLUE="\e[34m"
BRIGHT_BLUE="\e[94m"
CYAN="\e[36m"
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

echo -e "${RED}[!] Authorized testing only. Do NOT run this against systems without written permission.${RESET}"

# ============================
# Usage
# ============================
if [ -z "$TARGET" ]; then
    echo -e "${BRIGHT_BLUE}Usage:${RESET} ./$SCRIPT_NAME <target-ip> [--proxy]"
    echo -e "       ./$SCRIPT_NAME 1.2.3.4"
    echo -e "       ./$SCRIPT_NAME 1.2.3.4 --proxy"
    exit 1
fi

# ============================
# RESULTS DIRECTORY + FILES
# ============================
SAFE_TARGET=${TARGET//[^0-9A-Za-z_.-]/_}
RESULTS_DIR="results_${SAFE_TARGET}_$DATE"
mkdir -p "$RESULTS_DIR"

PING_FILE="$RESULTS_DIR/ping_results.txt"
TCP_FILE="$RESULTS_DIR/nmap_all_ports.txt"
UDP_FILE="$RESULTS_DIR/nmap_udp_scan.txt"
DETAIL_FILE="$RESULTS_DIR/nmap_detailed_scan.txt"
VULN_FILE="$RESULTS_DIR/nmap_vuln_scan.txt"
BANNERS_FILE="$RESULTS_DIR/banners.txt"
NIKTO_FILE="$RESULTS_DIR/nikto_results.txt"
SSLSCAN_FILE="$RESULTS_DIR/sslscan_results.txt"
SUMMARY_FILE="$RESULTS_DIR/summary.txt"
EYE_DIR="$RESULTS_DIR/eyewitness_output"

# ============================
# TOOL CHECKS
# ============================
REQUIRED_TOOLS=(nmap nc)
MISSING=0

for tool in "${REQUIRED_TOOLS[@]}"; do
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo -e "${RED}[!] Required tool '$tool' not found in PATH.${RESET}"
        MISSING=1
    fi
done

if [ "$MISSING" -ne 0 ]; then
    echo -e "${RED}[!] Install the missing tools and re-run the script.${RESET}"
    exit 1
fi

# Optional tools (we'll check inline where used)
have_nikto=0
have_sslscan=0
have_eyewitness=0

if command -v nikto >/dev/null 2>&1; then
    have_nikto=1
else
    echo -e "${YELLOW}[!] nikto not found – web vuln scan will be skipped.${RESET}"
fi

if command -v sslscan >/dev/null 2>&1; then
    have_sslscan=1
else
    echo -e "${YELLOW}[!] sslscan not found – SSL scan will be skipped.${RESET}"
fi

if command -v eyewitness >/dev/null 2>&1; then
    have_eyewitness=1
else
    echo -e "${YELLOW}[!] eyewitness not found – screenshots will be skipped.${RESET}"
fi

echo -e "${BRIGHT_BLUE}=== Starting Reconnaissance on $TARGET ($DATE) ===${RESET}"

##############################
# PROXYCHAINS MODE
##############################
if [[ "$MODE" == "--proxy" ]]; then
    echo -e "${CYAN}[*] ProxyChains mode enabled.${RESET}"

    echo -e "${YELLOW}[*] Skipping ping (not supported through proxychains)…${RESET}"

    echo -e "${CYAN}[*] Running proxy-compatible Nmap TCP scan...${RESET}"
    proxychains nmap -Pn -sT -p- -T3 -oN "$TCP_FILE" "$TARGET"

    echo -e "${YELLOW}[*] Skipping UDP scan (not supported through proxychains).${RESET}"

    echo -e "${CYAN}[*] Running limited service/version detection...${RESET}"
    proxychains nmap -Pn -sT -sV -oN "$DETAIL_FILE" "$TARGET"

    echo -e "${CYAN}[*] Grabbing banners through proxychains...${RESET}"
    grep "open" "$TCP_FILE" | while read -r line; do
        PORT=$(echo "$line" | cut -d "/" -f1)
        echo -e "${CYAN}[*] Connecting to port $PORT...${RESET}"
        proxychains nc -nv "$TARGET" "$PORT" < /dev/null | head -n 5 >> "$BANNERS_FILE" 2>/dev/null
    done

    echo -e "${CYAN}[*] Checking for web services...${RESET}"
    if grep -E "80/tcp open|443/tcp open" "$TCP_FILE" > /dev/null; then

        if [ "$have_nikto" -eq 1 ]; then
            echo -e "${CYAN}[*] Running Nikto through proxychains...${RESET}"
            proxychains nikto -h "$TARGET" -output "$NIKTO_FILE"
        fi

        if [ "$have_sslscan" -eq 1 ]; then
            echo -e "${CYAN}[*] Running SSL scan through proxychains...${RESET}"
            proxychains sslscan "$TARGET" > "$SSLSCAN_FILE"
        fi
    fi

    echo -e "${YELLOW}[*] Skipping NSE vuln scan (not reliable through proxychains).${RESET}"

    if [ "$have_eyewitness" -eq 1 ]; then
        echo -e "${CYAN}[*] Taking screenshots of web services...${RESET}"
        eyewitness --web -f "$TCP_FILE" --no-dns -d "$EYE_DIR"
    fi

##############################
# NORMAL MODE
##############################
else
    echo -e "${CYAN}[*] Normal mode enabled.${RESET}"

    echo -e "${CYAN}[*] Checking if host is up...${RESET}"
    ping -c 3 "$TARGET" > "$PING_FILE"

    echo -e "${CYAN}[*] Running Nmap full TCP port scan...${RESET}"
    nmap -p- -T4 -oN "$TCP_FILE" "$TARGET"

    echo -e "${CYAN}[*] Running Nmap UDP scan (this can be slow)...${RESET}"
    nmap -sU -oN "$UDP_FILE" "$TARGET"

    echo -e "${CYAN}[*] Running Nmap service version scan...${RESET}"
    nmap -sV -sC -O -oN "$DETAIL_FILE" "$TARGET"

    echo -e "${CYAN}[*] Grabbing banners from detected services...${RESET}"
    grep "open" "$TCP_FILE" | while read -r line; do
        PORT=$(echo "$line" | cut -d "/" -f1)
        echo -e "${CYAN}[*] Connecting to port $PORT...${RESET}"
        (echo "" | nc -nv "$TARGET" "$PORT" | head -n 5) >> "$BANNERS_FILE" 2>/dev/null
    done

    echo -e "${CYAN}[*] Checking for web services...${RESET}"
    if grep -E "80/tcp open|443/tcp open" "$TCP_FILE" > /dev/null; then

        if [ "$have_nikto" -eq 1 ]; then
            echo -e "${CYAN}[*] Running Nikto scan...${RESET}"
            nikto -h "$TARGET" -output "$NIKTO_FILE"
        fi

        if [ "$have_sslscan" -eq 1 ]; then
            echo -e "${CYAN}[*] Running SSL scan...${RESET}"
            sslscan "$TARGET" > "$SSLSCAN_FILE"
        fi
    fi

    echo -e "${CYAN}[*] Running safe Nmap vulnerability scripts...${RESET}"
    nmap --script vuln -oN "$VULN_FILE" "$TARGET"

    if [ "$have_eyewitness" -eq 1 ]; then
        echo -e "${CYAN}[*] Taking screenshots of web services...${RESET}"
        eyewitness --web -f "$TCP_FILE" --no-dns -d "$EYE_DIR"
    fi
fi

##############################
# SUMMARY REPORT
##############################

echo -e "${CYAN}[*] Creating summary report...${RESET}"

{
    echo "=== Summary Report for $TARGET ($DATE) ==="
    echo ""

    if [ -f "$TCP_FILE" ]; then
        echo "Open TCP Ports:"
        grep "open" "$TCP_FILE"
        echo ""
    fi

    if [ -f "$DETAIL_FILE" ]; then
        echo "Detected Services:"
        grep "open" "$DETAIL_FILE"
        echo ""
    fi

    if [ -f "$NIKTO_FILE" ]; then
        echo "Web Findings (Nikto):"
        cat "$NIKTO_FILE"
        echo ""
    fi

    if [ -f "$SSLSCAN_FILE" ]; then
        echo "SSL Findings (sslscan):"
        grep -Ei "weak|expired|SSL|TLS" "$SSLSCAN_FILE" || true
        echo ""
    fi

} > "$SUMMARY_FILE"

echo ""
echo -e "${GREEN}=== Scan Complete ===${RESET}"
echo "Results saved in: $RESULTS_DIR"
[ -f "$PING_FILE" ]      && echo "   $(basename "$PING_FILE")"
[ -f "$TCP_FILE" ]       && echo "   $(basename "$TCP_FILE")"
[ -f "$UDP_FILE" ]       && echo "   $(basename "$UDP_FILE") (normal mode only)"
[ -f "$DETAIL_FILE" ]    && echo "   $(basename "$DETAIL_FILE")"
[ -f "$VULN_FILE" ]      && echo "   $(basename "$VULN_FILE") (normal mode only)"
[ -f "$BANNERS_FILE" ]   && echo "   $(basename "$BANNERS_FILE")"
[ -f "$NIKTO_FILE" ]     && echo "   $(basename "$NIKTO_FILE") (if applicable)"
[ -f "$SSLSCAN_FILE" ]   && echo "   $(basename "$SSLSCAN_FILE") (if applicable)"
[ -d "$EYE_DIR" ]        && echo "   $(basename "$EYE_DIR")/"
[ -f "$SUMMARY_FILE" ]   && echo "   $(basename "$SUMMARY_FILE")"
