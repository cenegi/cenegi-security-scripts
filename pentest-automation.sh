#!/bin/bash

# Basic Pentest Recon Script
# For authorized security assessments only

TARGET=$1
MODE=$2        # captures flags like --proxy
DATE=$(date +"%Y-%m-%d_%H-%M")

# ============================
# COLOR PALETTE (Blue-themed)
# ============================
BLUE="\e[34m"
BRIGHT_BLUE="\e[94m"
CYAN="\e[36m"
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

# ============================
# Usage
# ============================
if [ -z "$TARGET" ]; then
    echo -e "${BRIGHT_BLUE}Usage:${RESET} ./recon.sh <target-ip> [--proxy]"
    echo -e "       ./recon.sh 1.2.3.4"
    echo -e "       ./recon.sh 1.2.3.4 --proxy"
    exit 1
fi

echo -e "${BRIGHT_BLUE}=== Starting Reconnaissance on $TARGET ($DATE) ===${RESET}"

##############################
# PROXYCHAINS MODE
##############################
if [[ "$MODE" == "--proxy" ]]; then
    echo -e "${CYAN}[*] ProxyChains mode enabled.${RESET}"

    echo -e "${YELLOW}[*] Skipping ping (not supported through proxychains)â€¦${RESET}"

    # Proxy-friendly TCP scan
    echo -e "${CYAN}[*] Running proxy-compatible Nmap TCP scan...${RESET}"
    proxychains nmap -Pn -sT -p- -T3 -oN nmap_all_ports_$DATE.txt $TARGET

    echo -e "${YELLOW}[*] Skipping UDP scan (not supported through proxychains).${RESET}"

    echo -e "${CYAN}[*] Running limited service/version detection...${RESET}"
    proxychains nmap -Pn -sT -sV -oN nmap_detailed_scan_$DATE.txt $TARGET

    echo -e "${CYAN}[*] Grabbing banners through proxychains...${RESET}"
    grep "open" nmap_all_ports_$DATE.txt | while read line; do
        PORT=$(echo $line | cut -d "/" -f1)
        echo -e "${CYAN}[*] Connecting to port $PORT...${RESET}"
        proxychains nc -nv $TARGET $PORT < /dev/null | head -n 5 >> banners_$DATE.txt 2>/dev/null
    done

    # Web checks
    echo -e "${CYAN}[*] Checking for web services...${RESET}"
    if grep -E "80/tcp open|443/tcp open" nmap_all_ports_$DATE.txt > /dev/null; then
        
        echo -e "${CYAN}[*] Running Nikto through proxychains...${RESET}"
        proxychains nikto -h $TARGET -output nikto_results_$DATE.txt
        
        echo -e "${CYAN}[*] Running SSL scan through proxychains...${RESET}"
        proxychains sslscan $TARGET > sslscan_results_$DATE.txt
    fi

    echo -e "${YELLOW}[*] Skipping NSE vuln scan (not reliable through proxychains).${RESET}"

    echo -e "${CYAN}[*] Taking screenshots of web services...${RESET}"
    eyewitness --web -f nmap_all_ports_$DATE.txt --no-dns -d eyewitness_output_$DATE

##############################
# NORMAL MODE
##############################
else
    echo -e "${CYAN}[*] Normal mode enabled.${RESET}"

    echo -e "${CYAN}[*] Checking if host is up...${RESET}"
    ping -c 3 $TARGET > ping_results_$DATE.txt

    echo -e "${CYAN}[*] Running Nmap full TCP port scan...${RESET}"
    nmap -p- -T4 -oN nmap_all_ports_$DATE.txt $TARGET

    echo -e "${CYAN}[*] Running Nmap UDP scan...${RESET}"
    nmap -sU -oN nmap_udp_scan_$DATE.txt $TARGET

    echo -e "${CYAN}[*] Running Nmap service version scan...${RESET}"
    nmap -sV -sC -O -oN nmap_detailed_scan_$DATE.txt $TARGET

    echo -e "${CYAN}[*] Grabbing banners from detected services...${RESET}"
    grep "open" nmap_all_ports_$DATE.txt | while read line; do
        PORT=$(echo $line | cut -d "/" -f1)
        echo -e "${CYAN}[*] Connecting to port $PORT...${RESET}"
        (echo "" | nc -nv $TARGET $PORT | head -n 5) >> banners_$DATE.txt 2>/dev/null
    done

    echo -e "${CYAN}[*] Checking for web services...${RESET}"
    if grep -E "80/tcp open|443/tcp open" nmap_all_ports_$DATE.txt > /dev/null; then
        
        echo -e "${CYAN}[*] Running Nikto scan...${RESET}"
        nikto -h $TARGET -output nikto_results_$DATE.txt
        
        echo -e "${CYAN}[*] Running SSL scan...${RESET}"
        sslscan $TARGET > sslscan_results_$DATE.txt
    fi

    echo -e "${CYAN}[*] Running safe Nmap vulnerability scripts...${RESET}"
    nmap --script vuln -oN nmap_vuln_scan_$DATE.txt $TARGET

    echo -e "${CYAN}[*] Taking screenshots of web services...${RESET}"
    eyewitness --web -f nmap_all_ports_$DATE.txt --no-dns -d eyewitness_output_$DATE
fi

##############################
# SUMMARY REPORT
##############################

echo -e "${CYAN}[*] Creating summary report...${RESET}"

echo "=== Summary Report for $TARGET ($DATE) ===" > summary_$DATE.txt
echo "" >> summary_$DATE.txt

echo "Open TCP Ports:" >> summary_$DATE.txt
grep "open" nmap_all_ports_$DATE.txt >> summary_$DATE.txt

echo "" >> summary_$DATE.txt
echo "Detected Services:" >> summary_$DATE.txt
grep "open" nmap_detailed_scan_$DATE.txt >> summary_$DATE.txt

echo "" >> summary_$DATE.txt
echo "Web Findings:" >> summary_$DATE.txt
[ -f nikto_results_$DATE.txt ] && cat nikto_results_$DATE.txt >> summary_$DATE.txt

echo "" >> summary_$DATE.txt
echo "SSL Findings:" >> summary_$DATE.txt
[ -f sslscan_results_$DATE.txt ] && grep -E "weak|expired|SSL|TLS" sslscan_results_$DATE.txt >> summary_$DATE.txt

echo ""
echo -e "${GREEN}=== Scan Complete ===${RESET}"
echo "Results saved:"
echo "   nmap_all_ports_$DATE.txt"
echo "   nmap_detailed_scan_$DATE.txt"
echo "   nmap_udp_scan_$DATE.txt (normal mode only)"
echo "   nmap_vuln_scan_$DATE.txt (normal mode only)"
echo "   banners_$DATE.txt"
echo "   nikto_results_$DATE.txt (if applicable)"
echo "   sslscan_results_$DATE.txt (if applicable)"
echo "   eyewitness_output_$DATE/"
echo "   summary_$DATE.txt"
