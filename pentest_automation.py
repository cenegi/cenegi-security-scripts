#!/usr/bin/env python3
import argparse
import subprocess
import os
import datetime
import sys

# ============================
#  COLOR SETUP (blue-focused)
# ============================
BLUE = "\033[94m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"
GREEN = "\033[92m"
YELLOW = "\033[93m"

# ============================
#  PERMISSION CHECK (Option 3)
# ============================
PERM_FILE = ".permission_ack"

def check_permission():
    """
    Checks if user has previously acknowledged authorization.
    If not, asks once and saves acknowledgment.
    """
    if os.path.exists(PERM_FILE):
        return True

    print(f"{YELLOW}{BOLD}⚠ AUTHORIZATION REQUIRED ⚠{RESET}")
    print("You must have explicit legal permission to test this target.")
    answer = input("Do you have authorization? (yes/no): ").strip().lower()

    if answer != "yes":
        print(f"{BLUE}Authorization not confirmed. Exiting.{RESET}")
        sys.exit(0)

    # Save authorization flag
    with open(PERM_FILE, "w") as f:
        f.write("authorized")

    print(f"{GREEN}Authorization confirmed. Continuing...{RESET}")
    return True

# ============================
#  RUN COMMANDS
# ============================
def run_cmd(cmd):
    """Runs a shell command safely and prints output."""
    print(f"\n{CYAN}{BOLD}→ Running:{RESET} {cmd}")
    try:
        subprocess.run(cmd, shell=True)
    except Exception as e:
        print(f"{YELLOW}Command failed: {e}{RESET}")

# ============================
#  MAIN LOGIC
# ============================
def main():
    # Parse arguments
    parser = argparse.ArgumentParser(description="Pentest Automation Script (Python Version)")
    parser.add_argument("--proxy", action="store_true", help="Route commands through proxychains")
    args = parser.parse_args()

    check_permission()

    # Timestamp + directory creation
    DATE = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M")
    OUTPUT_DIR = f"scan_{DATE}"
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    print(f"{GREEN}Output Directory:{RESET} {OUTPUT_DIR}")

    # Proxychains prefix
    PROXY = "proxychains " if args.proxy else ""

    print(f"{BLUE}{BOLD}Proxy Mode:{RESET} {'ON' if args.proxy else 'OFF'}")

    # ============================
    #   TARGET INPUT
    # ============================
    target = input(f"{CYAN}Enter target IP or domain: {RESET}").strip()
    if not target:
        print(f"{YELLOW}No target provided. Exiting.{RESET}")
        sys.exit(0)

    # ============================
    #   MENU LOOP
    # ============================
    while True:
        print(f"""
{BLUE}{BOLD}Select an option:{RESET}

1. Basic Nmap Scan
2. Full TCP + Service Enumeration
3. Banner Grab (80, 443, 22, 21, 25, 110, 445)
4. Run All
5. Exit
""")

        choice = input("Choice: ").strip()

        # ----------------------------------
        # 1. BASIC NMAP SCAN
        # ----------------------------------
        if choice == "1":
            print(f"{CYAN}Running Basic Nmap Scan...{RESET}")
            cmd = f"{PROXY}nmap -sV -oN {OUTPUT_DIR}/basic_nmap.txt {target}"
            # PLACEHOLDER: Replace above with your exact command if needed
            run_cmd(cmd)

        # ----------------------------------
        # 2. FULL SCAN
        # ----------------------------------
        elif choice == "2":
            print(f"{CYAN}Running Full TCP Scan...{RESET}")
            cmd = f"{PROXY}nmap -p- -sV -sC -oN {OUTPUT_DIR}/full_scan.txt {target}"
            # PLACEHOLDER
            run_cmd(cmd)

        # ----------------------------------
        # 3. BANNER GRAB
        # ----------------------------------
        elif choice == "3":
            print(f"{CYAN}Running Banner Grabbing...{RESET}")
            ports = [80, 443, 22, 21, 25, 110, 445]

            for p in ports:
                outfile = f"{OUTPUT_DIR}/banner_{p}.txt"
                cmd = f"{PROXY}nc -nv {target} {p} > {outfile}"
                # PLACEHOLDER
                run_cmd(cmd)

        # ----------------------------------
        # 4. RUN ALL
        # ----------------------------------
        elif choice == "4":
            print(f"{GREEN}{BOLD}Running ALL modules...{RESET}")

            # BASIC SCAN
            run_cmd(f"{PROXY}nmap -sV -oN {OUTPUT_DIR}/basic_nmap.txt {target}")

            # FULL SCAN
            run_cmd(f"{PROXY}nmap -p- -sV -sC -oN {OUTPUT_DIR}/full_scan.txt {target}")

            # BANNERS
            for p in [80, 443, 22, 21, 25, 110, 445]:
                run_cmd(f"{PROXY}nc -nv {target} {p} > {OUTPUT_DIR}/banner_{p}.txt")

        # ----------------------------------
        # 5. EXIT
        # ----------------------------------
        elif choice == "5":
            print(f"{BLUE}Exiting script. Summary below...{RESET}")
            break

        else:
            print(f"{YELLOW}Invalid choice.{RESET}")

    # ============================
    #   SUMMARY
    # ============================
    print(f"\n{BOLD}{GREEN}Scan Complete!{RESET}")
    print(f"Results saved in: {OUTPUT_DIR}\n")

# ============================
# ENTRY POINT
# ============================
if __name__ == "__main__":
    main()
